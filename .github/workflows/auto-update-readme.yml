name: Auto Update README Stats

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight
  workflow_dispatch:  # Manual trigger

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Update download stats
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const { data: releases } = await github.rest.repos.listReleases({
            owner: context.repo.owner,
            repo: context.repo.repo
          });
          
          let totalDownloads = 0;
          releases.forEach(release => {
            release.assets.forEach(asset => {
              totalDownloads += asset.download_count;
            });
          });
          
          console.log(`Total downloads: ${totalDownloads}`);
          
          // Update README with stats
          let readme = fs.readFileSync('README.md', 'utf8');
          const statsRegex = /!\[Downloads\]\(https:\/\/img\.shields\.io\/badge\/downloads-\d+-blue\.svg\)/;
          const newBadge = `![Downloads](https://img.shields.io/badge/downloads-${totalDownloads}-blue.svg)`;
          
          if (statsRegex.test(readme)) {
            readme = readme.replace(statsRegex, newBadge);
          }
          
          fs.writeFileSync('README.md', readme);
    
    - name: Commit changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add README.md
        git diff --quiet && git diff --staged --quiet || git commit -m "chore: update download stats [skip ci]"
        git push
